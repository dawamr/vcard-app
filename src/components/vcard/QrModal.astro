---
import { getDirectusAssetUrl } from '../../lib/directus';

interface Props {
  photoId: string | null;
  firstName: string;
  lastName: string;
  title: string;
  company: string;
  qrcodeId: string | null;
  slug: string;
}

const { photoId, firstName, lastName, title, company, qrcodeId, slug } = Astro.props;

const photoUrl = getDirectusAssetUrl(photoId, { width: 200, format: 'webp' });
const qrUrl = getDirectusAssetUrl(qrcodeId, { width: 400 });
const fullName = `${firstName} ${lastName}`.trim();

// Generate QR code URL using external service if no qrcodeId
const vcardUrl = `${Astro.url.origin}/${slug}`;
// Use orange accent from root as main QR color
const fallbackQrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodeURIComponent(vcardUrl)}&bgcolor=ffffff&color=F59E0B`;
const displayQrUrl = qrUrl || fallbackQrUrl;
---

<!-- Backdrop -->
<div 
  id="qr-backdrop" 
  class="backdrop fixed inset-0 z-50 bg-black/70"
  aria-hidden="true"
></div>

<!-- Bottom Sheet Modal -->
<div 
  id="qr-modal" 
  class="bottom-sheet fixed inset-x-0 bottom-0 z-50 rounded-t-3xl bg-[color:var(--color-bg-card)] p-6 pb-10"
>
  <!-- Handle -->
  <div class="mb-6 flex justify-center">
    <div class="h-1.5 w-12 rounded-full bg-gray-300 dark:bg-gray-500"></div>
  </div>

  <!-- Profile Info -->
  <div class="flex flex-col items-center text-center mb-6">
    {photoUrl ? (
      <img
        src={photoUrl}
        alt={fullName}
        loading="lazy"
        class="mb-4 h-24 w-24 rounded-full object-cover ring-2 ring-gray-300 dark:ring-gray-600"
      />
    ) : (
      <div class="mb-4 flex h-24 w-24 items-center justify-center rounded-full bg-slate-200 dark:bg-[#333] text-2xl font-bold text-slate-700 dark:text-white ring-2 ring-slate-300 dark:ring-gray-600">
        {firstName.charAt(0)}{lastName.charAt(0)}
      </div>
    )}
    <h3 class="text-xl font-bold text-[color:var(--color-text-primary)]">{fullName}</h3>
    <p class="text-sm text-[color:var(--color-text-secondary)]">{title}</p>
    <p class="text-sm font-semibold text-[color:var(--color-text-primary)]">{company}</p>
  </div>

  <!-- QR Code -->
  <div class="flex justify-center">
    <div class="rounded-3xl border-4 border-[color:var(--color-accent)] bg-white dark:bg-white p-4 shadow-lg">
      <img
        src={displayQrUrl}
        alt={`QR Code for ${fullName}`}
        loading="lazy"
        class="h-48 w-48"
      />
    </div>
  </div>
</div>

<script>
  // Close modal on backdrop click
  document.getElementById('qr-backdrop')?.addEventListener('click', () => {
    document.getElementById('qr-modal')?.classList.remove('open');
    document.getElementById('qr-backdrop')?.classList.remove('open');
  });
</script>
